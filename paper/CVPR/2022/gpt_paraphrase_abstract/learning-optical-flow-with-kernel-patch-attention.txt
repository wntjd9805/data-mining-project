Optical flow is a widely used method for measuring motion on the image plane. In recent years, deep learning approaches have focused on matching features to estimate motion. However, the importance of spatial smoothness in understanding motion has been overlooked. In this study, we propose a new approach called kernel patch attention (KPA) that considers local context relations to improve dense matching and resolve ambiguity. KPA operates on each local patch and learns to determine the context affinities for more accurate flow field inference. By incorporating KPA into optical flow architecture, our model can analyze motion comprehensively by considering both feature similarities and spatial relations. We evaluated our approach on the Sintel dataset and achieved the best performance with an EPE (endpoint error) of 1.35 on clean pass and 2.36 on final pass. On the KITTI-15 benchmark, our approach achieved a new record of 4.60% in F1-all. The code for our approach is publicly available at https://github.com/megvii-research/KPAFlow.