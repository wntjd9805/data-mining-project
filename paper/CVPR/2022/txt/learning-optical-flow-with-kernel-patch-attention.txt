Abstract
Optical ﬂow is a fundamental method used for quanti-tative motion estimation on the image plane. In the deep learning era, most works treat it as a task of ‘matching of features’, learning to pull matched pixels as close as possi-ble in feature space and vice versa. However, spatial afﬁnity (smoothness constraint), another important component for motion understanding, has been largely overlooked. In this paper, we introduce a novel approach, called kernel patch attention (KPA), to better resolve the ambiguity in dense matching by explicitly taking the local context relations into consideration. Our KPA operates on each local patch, and learns to mine the context afﬁnities for better inferring the
ﬂow ﬁelds. It can be plugged into contemporary optical ﬂow architecture and empower the model to conduct comprehen-sive motion analysis with both feature similarities and spa-tial relations. On Sintel dataset, the proposed KPA-Flow achieves the best performance with EPE of 1.35 on clean pass and 2.36 on ﬁnal pass, and it sets a new record of 4.60% in F1-all on KITTI-15 benchmark. Code is pub-licly available at https://github.com/megvii-research/KPAFlow. 1.

Introduction
Optical ﬂow is a fundamental technique used to charac-terize and quantify motion between two video frames, that facilitates a large number of real-life applications including visual tracking [39], video inpainting [45] and autonomous driving [8]. Recent deep learning based methods have made signiﬁcant breakthroughs by i) learning discriminative fea-tures with advanced training paradigms (e.g., reinforce-ment learning [1] and alternative learning [17, 34, 50]), ii) seeking/incorporating extra clues from the given scene [32] and iii) utilizing multi-frame information [19]. However, most contemporary works address the cross-image match-ing problem by learning and measuring feature similari-ties, overlooking another core component for motion under-*Corresponding author
Figure 1. A challenging image pair with heavy motion blur from the ﬁnal pass of Sintel test set. Unlike previous works (RAFT [36] and GMA [20]) suffering from ambiguous matching, our KPA-Flow is able to simultaneously mine the context and spa-tial afﬁnities for better inferring the ﬂow ﬁelds. The attention map of GMA contains many globally misleading clues while ours ef-fectively avoids the noise. “P” indicates the attention point. standing — the spatial relations which reveal the underlying afﬁnities during motion.
Traditional optical ﬂow algorithms formulate the dense matching as an energy minimization problem, explicitly considering both feature similarities and spatial smooth-ness [5, 6, 13]. Although the hand-crafted features used by those traditional methods suffer from scale and shape vari-ations, the smoothness constraint, to a great extent, helps to
ﬁx errors by taking the spatial relations into consideration.
In the deep learning era, most contemporary optical ﬂow methods largely focus on addressing the feature-matching similarities (e.g., using 4D correlation volumes [36]), ex-pecting that the extracted features by deep models are dis-Indeed, criminative enough for estimating ﬂow ﬁelds. recent advances in deep learning have provided signif-icant improvements in the ability to extract discrimina-tive/invariant features for matching in a data-driven manner, largely improving the reliability of optical ﬂow. However, as optical ﬂow itself is a complicated task, solely counting on ‘perfect’ features is still sub-optimal, making the deep model become fragile when dealing with some challenging cases (see Fig. 1). We believe that explicitly considering both feature similarities and spatial relations would help to build a powerful deep model that can understand motion at a higher level.
Using deep learning techniques to capture and model lo-cal relations is challenging. First, because the motion of ob-ject(s) appears locally in the visual scene, effectively captur-ing the local relations (afﬁnities) is vital for motion analysis.
However, common relation modeling approaches, such as non-local operations [41] and graph reasoning [9,27], focus on solving the global or long-range dependencies. How to reasonably model the local relations is still under-explored.
Second, the local relations should be end-to-end learnable, so as to best mine pairwise relationships described by the afﬁnity value. Third, optical ﬂow estimation is a per-pixel matching task, thus it is difﬁcult to efﬁciently obtain the pixel-wise relations. Last but not the least, the designed module is expected to be easily plugged into contemporary optical ﬂow architectures.
Targeting the above challenges and enabling a deeper un-derstanding of motion, we introduce a novel kernel patch at-tention (KPA) that explicitly focuses on local relations, and captures motion afﬁnities to better infer the optical ﬂow. To address the ﬁrst two challenges, we draw inspirations from the non-local operation [41] to learn the pixel-wise relations by comparisons. But differently, our KPA is formulated as a kernel-based operator, which conducts relation reason-ing within each local patch and achieves the smoothed mo-tion features in a sliding window manner. Importantly, our
KPA operates on both context and motion features; That is, for each location, KPA mines relations over its local sur-roundings using context features and takes advantage of the mined information to update the motion features. For the third challenge, our KPA is designed to work in a patch-wise manner by treating a group of pixels as ‘centres’ and computing local relations simultaneously so as to reduce the computational complexity. Finally, we formulate all rela-tion reasoning and feature updating operations with differ-entiable operations, which are implemented by using neural networks. Thus, it can be easily plugged into existing opti-cal ﬂow architecture and can be trained with other compo-nents together.
Using 4D all-pairs correlation volume (CV), recurrent reﬁnement scheme [36] and our proposed KPA, we design a powerful deep ﬂow model, called KPA-Flow, to explicitly handle both feature similarities and spatial afﬁnities within a uniﬁed framework for optical ﬂow. Our KPA-Flow is able to infer reliable ﬂows in different challenging cases (see
Fig. 1), achieving top-ranked performance on both Sintel and KITTI benchmarks. The contributions of this work are summarized as:
• A fully-differentiable approach for explicitly con-ducting the smooth constraint. To the best of our knowledge, we are the ﬁrst to explicitly handle the lo-cal relations for optical ﬂow based on the context and spatial afﬁnities. We present a kernel-based function to effectively mine local relations and use the mined information to infer the ﬂow ﬁelds.
• A novel operator for comprehensive optical ﬂow es-timation. We propose kernel patch attention (KPA) operator with a speciﬁc patch-based sliding window strategy, which is simple yet effective for reliable mo-tion understanding.
• State-of-the-art results on widely-used bench-marks. The fully-equipped KPA-Flow can reliable in-fer the optical ﬂow in challenging scenes, which sets new records on both Sintel and KITTI benchmarks with limited extra computational cost. 2.