Abstract
Cross-domain weakly supervised object detection (CD-WSOD) aims to adapt the detection model to a novel tar-get domain with easily acquired image-level annotations.
How to align the source and target domains is critical to the CDWSOD accuracy. Existing methods usually focus on partial detection components for domain alignment. In contrast, this paper considers that all the detection com-ponents are important and proposes a Holistic and Hier-archical Feature Alignment (H2FA) R-CNN. H2FA R-CNN enforces two image-level alignments for the backbone fea-tures, as well as two instance-level alignments for the RPN and detection head. This coarse-to-fine aligning hierar-chy is in pace with the detection pipeline, i.e., process-ing the image-level feature and the instance-level features from bottom to top. Importantly, we devise a novel hybrid supervision method for learning two instance-level align-ments. It enables the RPN and detection head to simultane-ously receive weak/full supervision from the target/source domains. Combining all these feature alignments, H2FA
R-CNN effectively mitigates the gap between the source and target domains. Experimental results show that H2FA
R-CNN significantly improves cross-domain object detec-tion accuracy and sets new state of the art on popular benchmarks. Code and pre-trained models are available at https://github.com/XuYunqiu/H2FA_R-CNN . 1.

Introduction
Cross-domain weakly supervised object detection (CD-WSOD) is of significant value in realistic detection applica-tions. Specifically, the training data and the testing data are sometimes under different domains (i.e., the source domain and target domain, respectively), yielding a cross-domain detection scenario. To mitigate the domain shift, there are three potential solutions, i.e., the supervised, unsupervised
*Work done during an internship at Baidu Research.
Figure 1. Our H2FA R-CNN employs four feature alignments, i.e., image-level (class-agnostic and class-wise) alignments and instance-level (foreground and class-wise) alignments for CDW-SOD. From the viewpoints of spatial granularity, semantic granu-larity and the supervision signals, there is a clear hierarchy from coarse to fine, which is paced with the detection pipeline from bot-tom to top. The novel Instance- and Image-level Recognition (IIR) unit is based on the RPN and detection head and is compatible to both full and weak supervision signals. and weakly supervised approaches. The supervised ap-proach requires additional densely annotated samples (i.e., instance-level bounding boxes) on the target domain, which can be very burdensome. In contrast, the unsupervised ap-proach [10,15,50] relieves the annotation cost, but generally achieves inferior detection accuracy. Therefore, many liter-ature [27, 30, 43] explore the weakly supervised approach (i.e., CDWSOD), which provides good trade-off between accuracy and annotation efficiency. Generally, CDWSOD improves cross-domain detection accuracy by adapting the deep model to the target domain with additional weak su-pervision signals (i.e., the image-level annotations).
We argue it is important to exploit the characteristics of the detection pipeline during the domain adaptation for
CDWSOD. Specifically, a popular cross-domain detection baseline adopts the two-stage pipeline [45] and is consisted of a backbone, a region proposal network (RPN) and a de-tection head. While the common sense is that all these three components are critical to the detection accuracy, ex-isting methods usually focus on partial components for do-main alignment. For instance, [27] aligns the backbone fea-tures and neglects aligning the RPN and detection head.
Some self-training-based methods [30, 43] use instance-level pseudo labels for adaptive training and can be viewed as directly aligning the features in the detection head. In contrast to the previous literature, we believe that all these components are important for domain alignment.
Such motivated, we propose a novel CDWSOD method named Holistic and Hierarchical Feature Alignment (H2FA)
R-CNN, as illustrated in Figure 1. H2FA R-CNN not only includes holistic detection components (i.e., the backbone, the RPN and the detection head) for domain alignment, but also organizes these multiple alignments in a hierarchical sequence in pace with the detection pipeline. We explain the hierarchical sequence as below: 1) Two image-level alignments for the backbone: When the detection pipeline is within the backbone, the network processes each image as a whole. Correspondingly, we en-force two image-level alignments (a class-agnostic and a class-wise one) on the backbone features. Such a class-agnostic → class-wise sequence is paced with the fact that the backbone feature gradually develops class-wise discrim-inative ability from bottom to top layers.
Specifically, the class-agnostic alignment uses adversar-ial domain classifiers to pull close two domains, without categorizing each image. In contrast, the class-wise domain alignment employs a multi-label classification task to learn a set of class-wise prototypes (a single prototype for a re-spective class). During training, each prototype pulls close the features (of the corresponding class) from two domains, therefore facilitating the class-wise alignment. 2) Two instance-level alignments for the RPN and detec-tion head: When the detection pipeline proceeds to the RPN and detection head, the network shifts to instance-level ob-ject recognition. Correspondingly, we enforce an instance-level foreground alignment for the RPN and an instance-level class-wise alignment for the detection head, respec-tively. Since the target domain does not provide instance-level but image-level annotations, we transform the vanilla
RPN and detection head into a novel Instance- and Image-level Recognition (IIR) unit (as introduced below), which is compatible to both weak and full supervision. Such a fore-ground → class-wise sequence is paced with the two-stage hierarchy of the detection baseline.
Apart from the overall framework, another important characteristic of H2FA R-CNN is the novel Instance- and
Image-level Recognition (IIR) unit. IIR unit has two func-tions: 1) IIR preserves the original instance-level recogni-tion function of the RPN and detection head; 2) IIR merges the outputs from the RPN and detection head for image-level recognition. Therefore, IIR can receive full/weak su-pervision from the source/target domains simultaneously, facilitating the desired instance-level alignments.
There is a clear hierarchy in the above aligning pipeline of image-level (class-agnostic → class-wise) ⇒ instance-level (foreground → class-wise).
In pace with the detec-tion pipeline from bottom to top, the semantic and spatial granularity of the alignments are from coarse to fine (see
Figure 1). Meanwhile, the supervision signals for learn-ing these alignments are from weak to strong (i.e., domain labels, image-level labels, and the hybrid image-level plus instance-level labels). We empirically show that the holis-tic and hierarchical characteristics are both important for
H2FA (see §4.4). Experimental results show that H2FA R-CNN significantly improves the cross-domain object detec-tion performance and sets new state of the art on popular benchmarks. Our main contributions can be summarized as follows:
• We propose the holistic and hierarchical feature align-ment (H2FA) R-CNN for the CDWSOD task. H2FA
R-CNN organizes two image-level and two instance-level alignments in a hierarchical manner.
• As an important component, we devise an Instance-and Image-level Recognition (IIR) unit to replace the vanilla RPN and detection head. IIR receives hybrid supervision from the source and target domains and facilitates instance-level alignments.
• We evaluate the proposed H2FA R-CNN through com-prehensive experiments. Experimental results demon-strate that H2FA R-CNN not only achieves state-of-the-art cross-domain object detection performance, but also has the advantage of strong noise robustness. 2.