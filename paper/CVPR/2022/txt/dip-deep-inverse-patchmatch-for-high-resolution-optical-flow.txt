Abstract
Recently, the dense correlation volume method achieves state-of-the-art performance in optical ﬂow. However, the correlation volume computation requires a lot of memory, which makes prediction difﬁcult on high-resolution images.
In this paper, we propose a novel Patchmatch-based frame-work to work on high-resolution optical ﬂow estimation.
Speciﬁcally, we introduce the ﬁrst end-to-end Patchmatch based deep learning optical ﬂow. It can get high-precision results with lower memory beneﬁting from propagation and local search of Patchmatch. Furthermore, a new inverse propagation is proposed to decouple the complex opera-tions of propagation, which can signiﬁcantly reduce calcu-lations in multiple iterations. At the time of submission, our method ranks 1st on all the metrics on the popular
KITTI2015 [28] benchmark , and ranks 2nd on EPE on the Sintel [7] clean benchmark among published optical
ﬂow methods. Experiment shows our method has a strong cross-dataset generalization ability that the F1-all achieves 13.73%, reducing 21% from the best published result 17.4% on KITTI2015. What’s more, our method shows a good de-tails preserving result on the high-resolution dataset DAVIS
[1] and consumes 2× less memory than RAFT [36]. Code will be available at github.com/zihuazheng/DIP 1.

Introduction
Optical ﬂow, the 2D displacement ﬁeld that describes ap-parent motion of brightness patterns between two succes-sive images [13], provides valuable information about the spatial arrangement of the viewed objects and the change rate of the arrangement [39]. Since Horn and Schunck (HS)
[13] and Lucas and Kanade (LK) [25] proposed the differ-ential method to calculate optical ﬂow in 1981, many ex-tension algorithms [22, 30, 42] have been proposed. Hence, optical ﬂow has been widely used in various applications such as visual surveillance tasks [43], segmentation [38], action recognition [31], obstacle detection [12] and image sequence super-resolution [26]. (a) Image (b) RAFT [36] (c) SCV [19] (d) Ours
Figure 1. Comparisons on high-resolution (1080 × 1920) images from DAVIS dataset. Compared with RAFT and SCV, our method has achieved better details with lower memory.
Recently, deep learning has made great progress in solv-ing the problem of optical ﬂow. Since FlowNetC [10], many methods have achieved state-of-the-art results. For deep learning, in addition to accuracy, performance and mem-ory are also challenges especially when predicting ﬂow at high-resolution. To reduce complexity of computation and usage of memory, previous approaches [16–18, 34, 46] use coarse-to-ﬁne strategy, they may suffer from low-resolution error recovery problems. In order to maintain high accuracy on large displacements, especially for fast moving small targets, RAFT [36] constructs an all-pairs 4D correlation volume and look up with a convolution GRU block. How-ever, it runs into memory problems when predicting high-resolution optical ﬂow.
In order to reduce the memory while maintaining high accuracy, instead of using the sparse global correlation strategies like [19, 44] which suffer from loss of accuracy, we introduce the idea of Patchmatch to the computation of correlation. Patchmatch implements a random initial-ization, iterative propagation and search algorithm for ap-It proximate nearest neighbor ﬁeld estimation [5, 6, 14]. only needs to perform correlation calculations on nearby pixels and propagate its cost information to the next match-ing point iteratively, without the need to construct a global matching cost. Therefore, the Patchmatch algorithm greatly reduces the memory overhead caused by the correlation vol-ume. Moreover, the iterative propagation and search in
Patchmatch can be easily achieved using GRU [36]. To this end, we propose a Patchmatch-based framework for optical ﬂow, which can effectively reduce memory while maintaining high accuracy.
It contains two key modules: propagation module and local search module. The prop-agation module reduces the search radius effectively, and the local search module accelerates convergence and further improves accuracy. At the same time, we have achieved high-resolution predictions of high-precision optical ﬂow through adaptive-layers iterations.
Furthermore, a new inverse propagation method is pro-posed, which offsets and stacks target patches in advance.
Then, it only needs to do warping once for all propagations compared with propagation which requires offset and warp-ing in each propagation, so as to reduce the calculation time signiﬁcantly.
We demonstrate our approach on the challenging Sin-tel [7] and KITTI-15 [28] datasets. Our model ranks ﬁrst on KITTI-15 and second on Sintel-Clean. Fig. 1 shows the results of our Deep Inverse Patchmatch(DIP). Comparing to previous approaches [20, 36], DIP keeps the best effect while memory usage is the lowest. At the same time, our method has a strong cross-dataset generalization that the
F1-all achieves 13.73%, reduced 21% from the best pub-lished result 17.4% on KITTI2015 [28].
In addition, the supplementary material shows the domain invariance of our
DIP in the Stereo ﬁeld.
To sum up, our main contributions include:
• We design an efﬁcient framework which introduces
Patchmatch to the end-to-end optical ﬂow prediction for the ﬁrst time. It can improve the accuracy of op-tical ﬂow while reducing the memory of correlation volume.
• We propose a novel inverse propagation module. Com-pared with propagation, it can effectively reduce calcu-lations while maintaining considerable performance.
• Our experiments demonstrate that the method achieves a good trade-off between performance and memory, a comparable results with the state of the art methods on public datasets and a good generalization on different datasets. introduced a warping mechanism and stacked hourglass net-work to promote the performance on small motion areas.
PWC-Net [34] used feature warping and a coarse-to-ﬁne cost volume with a context network for ﬂow reﬁnement, further improving the accuracy and reducing the model size simultaneously. To address ambiguous correspondence and occlusion problem, Hui et al. [15] proposed LiteFlowNet3 with adaptive afﬁne transformation and local ﬂow consis-tency restrictions. RAFT [36] introduced a shared weight it-erative reﬁnement module to update the ﬂow ﬁeld retrieved from a 4D all-pair correlation volume. To reduce the com-putation complexity of 2D searching in high-resolution im-ages, Xu et al. [44] factorized the 2D search to 1D in two
Jiang et directions combined with attention mechanism. al. [20] proposed to construct a sparse correlation volume directly by computing the k-Nearest matches in one feature map for each feature vector in the other feature map. The memory consumption of them is less compare to RAFT but their accuracy is inferior. Another line of work is focused on joining image segmentation and ﬂow estimation task to-gether [8,9,33,37], which propagated two different comple-mentary features, aiming at improving the performance of
ﬂow estimation and vice versa.
Patchmatch Based Methods Patchmatch has been orig-inally proposed by Barnes et al. [5].
Its core work is to compute patch correspondences in a pair of images. The key idea behind it is that neighboring pixels usually have coherent matches. M Bleyer et al. [6] applied Patchmatch to stereo matching and proposed a slanted support windows method for computing aggregation to obtain sub-pixel dis-parity precision. In order to reduce the error caused by the motion discontinuity of Patchmatch in optical ﬂow, Bao et al. [3] proposed the Edge-Preserving Patchmatch algorithm.
Hu et al. [14] proposed a Coarse-to-Fine Patchmatch strat-egy to improve the speed and accuracy of optical ﬂow. In deep learning, Bailer et al. [2] regarded Patchmatch as a 2-classiﬁcation problem and proposed a thresholded loss to improve the accuracy of classiﬁcation. Shivam et al. [11] developed a differentiable Patchmatch module to achieve real-time in the stereo disparity estimation network. But this method is sparse and only works on the disparity di-mension. Wang et al. [40] introduced iterative multi-scale
Patchmatch, which used one adaptive propagation and dif-ferentiable warping strategy, achieved a good performance in the Multi-View Stereo problem. 2.