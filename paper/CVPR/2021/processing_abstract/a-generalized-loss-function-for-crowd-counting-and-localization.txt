Previous work [40] shows that a better density map rep-resentation can improve the performance of crowd count-ing. In this paper, we investigate learning the density map representation through an unbalanced optimal transport problem, and propose a generalized loss function to learn density maps for crowd counting and localization. We prove that pixel-wise L2 loss and Bayesian loss [29] are special cases and suboptimal solutions to our proposed loss func-tion. A perspective-guided transport cost function is further proposed to better handle the perspective transformation in crowd images. Since the predicted density will be pushed to-ward annotation positions, the density map prediction will be sparse and can naturally be used for localization. Fi-nally, the proposed loss outperforms other losses on four large-scale datasets for counting, and achieves the best lo-calization performance on NWPU-Crowd and UCF-QNRF. 