Abstract
Compositing an image usually inevitably suffers from inharmony problem that is mainly caused by incompat-ibility of foreground and background from two different images with distinct surfaces and lights, corresponding to material-dependent and light-dependent characteristics, namely, reﬂectance and illumination intrinsic images, re-spectively. Therefore, we seek to solve image harmoniza-tion via separable harmonization of reﬂectance and illu-mination, i.e., intrinsic image harmonization. Our method is based on an autoencoder that disentangles composite image into reﬂectance and illumination for further sepa-rate harmonization. Speciﬁcally, we harmonize reﬂectance through material-consistency penalty, while harmonize il-lumination by learning and transferring light from back-ground to foreground, moreover, we model patch relations between foreground and background of composite images in an inharmony-free learning way, to adaptively guide our intrinsic image harmonization. Both extensive exper-iments and ablation studies demonstrate the power of our method as well as the efﬁcacy of each component. We also contribute a new challenging dataset for benchmark-ing illumination harmonization. Code and dataset are at https://github.com/zhenglab/IntrinsicHarmony. 1.

Introduction
The visual appearance of two images will be distinct due to different light and scene while imaging [54, 60].
Thus, compositing an image, i.e., extracting a foreground region in one image and pasting it with the background of another image, will inevitably suffer from the inharmony problem caused by distinct appearance between the two im-ages (see Figure 1 for example), which signiﬁcantly de-*Corresponding author (zhenghaiyong@ouc.edu.cn).
This work was supported in part by the Finance Science and Technol-ogy Project of Hainan Province under Grant ZDKJ202017, and the Na-tional Natural Science Foundation of China under Grant 61771440 and
Grant 41776113.
Real
Composite
DoveNet
Ours
Figure 1. Thanks to separate intrinsic image harmonization, our method can adjust the illumination of foreground to make it com-patible with background while keep reﬂectance constant. We show examples from iHarmony4 [11] (top) and our HVIDIT (bottom). grades the quality of composite result [49, 12, 11]. Be-sides, many computer vision tasks, especially image/video synthesis, such as image editing [38, 2, 44], image inpaint-ing [34, 55, 41], and image stitching [9, 56, 57], will also en-counter this inharmony problem because of the compositing process. However, human visual system is very sensitive to the inharmony in appearance, e.g., human eyes can iden-tify very subtle distinctions in color and contrast [30, 54].
Therefore, image harmonization, which aims to make the appearance of foreground and background in the composite image compatible [47, 49, 11, 12], is full of challenges.
Essentially, the appearance of a natural image depends on various factors in the scene, such as illumination, ma-terial, and shape [58, 3]. Moreover, human visual system is remarkable in its ability to estimate characteristics in-trinsic to the scene, such as color, size, shape, or illumi-nation, where each intrinsic characteristic corresponds to one intrinsic image [4]. Thus, humans are able to distin-guish composite images, mainly owing to the apparent abil-ity to estimate intrinsic characteristics in unfamiliar scenes.
Besides, the light intensity values represented in an image actually encode all the characteristics of the corresponding scene points [4]. Hence, harmonizing each intrinsic image separately, rather than adjusting intensity values for harmo-nization, is essential and crucial for image harmonization.
The inharmony in composite images is caused by the in-compatibility of foreground and background from two dif-16367
ferent scenes [49, 11], mainly lying in: (1) the boundaries of foreground surfaces (e.g., object, person, etc.) are not in harmony with the background [47], corresponding to the intrinsic characteristic of surface; and (2) the illumination of foreground (from one image) and background (from an-other image) is not harmonious [47, 11], corresponding to the intrinsic characteristic of illumination. Thus, to solve image harmonization, it is intuitive and will be much bene-ﬁcial to disentangle composite image into intrinsic images of surface and illumination for separate harmonization.
Retinex theory [33, 31] addresses the problem of separat-ing illumination from reﬂectance in a given image, where illumination represents the intrinsic light-dependent char-acteristic of scene, while reﬂectance describes the intrinsic material-dependent characteristic of surface that is invariant to illumination and imaging conditions [26, 15, 35]. There-fore, in this work, we seek to solve image harmonization via separable harmonization of reﬂectance and illumination intrinsic images, i.e., intrinsic image harmonization.
In this paper, we formulate image harmonization as an autoencoder that internally disentangle composite image into reﬂectance and illumination for separate harmoniza-tion. For reﬂectance, we leverage material-consistency as a penalty cue to harmonize foreground boundaries while keeping reﬂectance constant. For illumination, we de-sign a lighting strategy to harmonize the incompatibility of foreground and background illumination. Moreover, we note that the inharmony will be more visually obvious if background and foreground have similar material (e.g., the top example in Figure 1), and a single natural image has powerful internal statistics that small patches recur abun-dantly [18, 61, 22], so compositing an image realistically and meaningfully should also follow this statistics, hence, we devise an inharmony-free learning way to model patch relations of foreground and background from composite im-ages for adaptively guiding intrinsic image harmonization.
Note that, our method is not aimed to achieve physically based intrinsic images, rather our goal is to tackle image harmonization problem via intrinsic image properties. Ac-tually, we are interested in relative, rather than absolute, re-ﬂectance and illumination, relying on intrinsic image prop-erties, which aims at harmonizing foreground to be compat-ible with background in the composite image. Therefore, we leverage both intrinsic image (as motivation) and im-age harmonization (as objective) to carefully design our net-work as well as losses, for eliminating inharmony of com-posite images (but not for intrinsic image decomposition).
Our contributions include: (1) we propose a novel method to harmonize composite images via separately har-monizing reﬂectance and illumination intrinsic images, as far as we can tell, this is the ﬁrst to model image harmo-nization based on intrinsic image theory; (2) we design a lighting strategy to learn light from image and transfer light from background to foreground for illumination harmoniza-tion; (3) we devise an implicit way to learn inharmony-free patch relations between foreground and background from composite images for adaptively guiding intrinsic image harmonization; (4) our method achieves state-of-the-art per-formance on both public synthesized dataset and real com-posite images, besides, we build a new HVIDIT dataset for benchmarking illumination harmonization. 2.