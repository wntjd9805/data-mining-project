This paper addresses the problem of restoring JPEG images that have been corrupted by bit errors in the encrypted bitstream. Existing image restoration methods are unable to resolve the color casts and block shifts caused by these errors. To overcome this challenge, the authors propose a robust JPEG decoder and a two-stage compensation and alignment framework. The decoder uses an error-resilient mechanism to decode the corrupted bitstream. The two-stage framework includes a self-compensation and alignment stage and a guided-compensation and alignment stage. The self-compensation stage performs adaptive block-wise color compensation and alignment based on estimated offsets. The guided-compensation stage utilizes a low-resolution thumbnail from the JPEG header to guide full-resolution pixel-wise image restoration. This is achieved through a coarse-guided pix2pix network and a refine-guided bi-directional Laplacian pyramid fusion network. The proposed method is evaluated on three benchmarks with varying bit error rates, and experimental results demonstrate its superiority. The code for the method is available at https://github.com/wenyang001/Two-ACIR.