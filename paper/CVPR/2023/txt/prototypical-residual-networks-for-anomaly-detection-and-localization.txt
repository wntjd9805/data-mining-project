Abstract
Anomaly detection and localization are widely used in industrial manufacturing for its efficiency and effectiveness.
Anomalies are rare and hard to collect and supervised mod-els easily over-fit to these seen anomalies with a handful of abnormal samples, producing unsatisfactory performance.
On the other hand, anomalies are typically subtle, hard to discern, and of various appearance, making it difficult to detect anomalies and let alone locate anomalous regions.
To address these issues, we propose a framework called
Prototypical Residual Network (PRN), which learns feature residuals of varying scales and sizes between anomalous and normal patterns to accurately reconstruct the segmen-tation maps of anomalous regions. PRN mainly consists of two parts: multi-scale prototypes that explicitly represent the residual features of anomalies to normal patterns; a multi-size self-attention mechanism that enables variable-sized anomalous feature learning. Besides, we present a variety of anomaly generation strategies that consider both seen and unseen appearance variance to enlarge and diversify anoma-lies. Extensive experiments on the challenging and widely used MVTec AD benchmark show that PRN outperforms cur-rent state-of-the-art unsupervised and supervised methods.
We further report SOTA results on three additional datasets to demonstrate the effectiveness and generalizability of PRN. 1.

Introduction
The human cognition and visual system has an inherent ability to perceive anomalies [53]. Not only can humans distinguish between defective and non-defective images, but they can also point to the location of anomalies even if they have seen none or only a limited number of anomalies.
Anomaly detection (image-level binary classification) and anomaly localization (pixel-level binary classification) are introduced for the same purpose, and have been widely used
∗ Corresponding author.
Figure 1. Anomaly detection and localization examples on MVTec
[4]. Compared with the unsupervised method PatchCore [41] and the supervised method DRA [13], the proposed PRN is able to locate the anomalous regions more accurately. in various scenarios due to their efficiency and remarkable accuracy, including industrial defect detection [4, 7, 34, 61], medical image analysis [52] and video surveillance [32].
Given its importance, a significant amount of work has been devoted to anomaly detection and anomaly localization, but few have addressed both detection and localization prob-lems well at the same time. We argue that real-world anoma-lous data weaken these models mainly in three aspects: I) the amount of abnormal samples is limited and significant fewer than normal samples, producing data distributions that lead to a naturally imbalanced learning problem; II) anomalies are typically subtle and hard to discern, since normal patterns still dominate the anomalous image; identifying abnormal regions out of the whole image is the key to anomaly detec-tion and localization; III) the appearance of anomalies varies significantly, i.e., abnormal regions can take on a variety of sizes, shapes and numbers, and such appearance variations
terns from concatenated feature memory [41] or random sampled feature maps [63], we construct normal patterns with prototypes of intermediate feature maps of different scales, thereby preserving the spatial information and provid-ing precise and representative normal patterns. Further, we obtain the feature map residuals via the deviation between the anomalous image and the closest prototype at each scale, and we add multi-scale fusion blocks to exchange informa-tion across different scales. Second, since the appearance of anomaly regions varies a lot, it is necessary to learn relation-ships among patches from multiple receptive fields. Thus, we introduce a multi-size self-attention [33, 55, 58, 59] mecha-nism, which operates on patches of different receptive fields to detect patch-level inconsistencies at different sizes. Fi-nally, unlike previous methods [13, 35] that use image-level supervision for training, our model learns to reconstruct the anomaly segmentation map with pixel-level supervision, which focuses more on the anomalous regions and preserves better generalization. Besides, we put forward a variety of anomaly generation strategies that efficiently mitigate the impact of data imbalance and enrich the anomaly appearance.
With the proposed modules, our method achieves more accu-rate localization than previous unsupervised and supervised methods, as shown in Fig. 1 and Fig. 2.
The main contributions of this paper are summarized as follows:
• We propose a novel Prototypical Residual Networks for anomaly detection and localization. Equipped with multi-scale prototypes and the multi-size self-attention mechanism, PRN learns residual representations among multi-scale feature maps and within the multi-size re-ceptive fields at each scale.
• We present a variety of anomaly generation strategies that considering both seen and unseen appearance vari-ance to enlarge and diversify anomalies.
• We perform extensive experiments on four datasets to show that our approach achieves new SOTA anomaly detection performance and outperforms current SOTA in anomaly localization performance by a large margin. 2.