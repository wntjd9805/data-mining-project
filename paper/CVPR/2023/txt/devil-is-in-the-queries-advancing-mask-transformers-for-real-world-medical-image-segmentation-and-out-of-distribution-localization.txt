Abstract
Real-world medical image segmentation has tremen-dous long-tailed complexity of objects, among which tail conditions correlate with relatively rare diseases and are clinically significant.
A trustworthy medical AI algo-rithm should demonstrate its effectiveness on tail condi-tions to avoid clinically dangerous damage in these out-of-distribution (OOD) cases. In this paper, we adopt the con-cept of object queries in Mask Transformers to formulate semantic segmentation as a soft cluster assignment. The queries fit the feature-level cluster centers of inliers dur-ing training. Therefore, when performing inference on a medical image in real-world scenarios, the similarity be-tween pixels and the queries detects and localizes OOD re-gions. We term this OOD localization as MaxQuery. Fur-thermore, the foregrounds of real-world medical images, whether OOD objects or inliers, are lesions. The differ-ence between them is less than that between the foreground and background, possibly misleading the object queries to focus redundantly on the background. Thus, we propose a query-distribution (QD) loss to enforce clear boundaries between segmentation targets and other regions at the query level, improving the inlier segmentation and OOD indi-cation. Our proposed framework is tested on two real-world segmentation tasks, i.e., segmentation of pancreatic and liver tumors, outperforming previous state-of-the-art algorithms by an average of 7.39% on AUROC, 14.69% on
AUPR, and 13.79% on FPR95 for OOD localization. On the other hand, our framework improves the performance of inlier segmentation by an average of 5.27% DSC when compared with the leading baseline nnUNet. 1.

Introduction
Image segmentation is a fundamental task in medical im-age analysis. With the recent advancements in computer
* Corresponding author. (yingda.xia@alibaba-inc.com)
† Work was done during an internship at Alibaba DAMO Academy
Figure 1. Real-world medical image segmentation. Real-world medical outliers (unseen, usually rare, tumors) are “near” to the inliers (labeled lesions), forming a typical near-OOD problem. A real-world medical OOD detection/localization model should fo-cus more on subtle differences between outliers and inliers than the significant difference between foreground and background.. vision and deep learning, automated medical image seg-mentation has reached expert-level performance in various applications
[3, 28, 54]. Most medical image segmenta-tion methods are based on supervised machine learning that heavily relies on collecting and annotating training data.
However, real-world medical images are long-tailed dis-tributed. The tail conditions are outliers and inadequate (or even unable) to train a reliable model [35, 61, 63]. Yet, the model trained with inliers is risky for triggering failures or errors in real-world clinical deployment
[43]. For exam-ple, in pancreatic tumor image analysis, a miss-detection of metastatic cancer will directly threaten life; an erroneous recognition of a benign cyst as malignant will lead to unnec-essary follow-up tests and patient anxiety. Medical image segmentation models should thus demonstrate the ability to detect and localize out-of-distribution (OOD) conditions, especially in some safety-critical clinical applications.
Previous studies have made valuable attempts on med-ical OOD localization [48, 65], including finding lesions
apart from normal cases or simulating OOD conditions for model validation. However, the real-world clinical scenario, such as tumor segmentation, is more complex, where either in-distribution or OOD cases have multiple types of tumors.
Establishing a direct relationship between image pixels and excessive semantics (types of tumors) is difficult for real-world medical image segmentation. Using this relationship to distinguish inliers and outliers is even more challenging.
Fortunately, several works about Mask Transformers [5, 9] have inspired us to split segmentation as a two-stage pro-cess of per-pixel cluster assignment and cluster classifica-tion [57, 58]. A well-defined set of inlier clusters may greatly benefit in identifying the OOD conditions from the medical images. Therefore, we propose MaxQuery, a med-ical image semantic segmentation framework that advances
Mask Transformers to localize OOD targets. The frame-work adopts learnable object queries to iteratively fit inlier cluster centers. Since the affinity between OODs and an inlier cluster center should be less than that within the clus-ter (between inliers and cluster centers), MaxQuery uses the negative of such affinity as an indicator to detect OODs.
Several recent works further define real-world medical image OOD localization as a near-OOD problem [43, 51], where the distribution gaps between inlier and OOD tumors are overly subtle, as shown in Fig. 1. Thus, the near-OOD problems are more difficult. Our pilot experiments show that the cluster centers redundantly represent the large re-gions of background and organ rather than tumors, compro-mising the necessary variability of the cluster assignments for OOD localization. To solve this issue, we propose the query-distribution (QD) loss to regularize specific quantities of object queries on background, organ, and tumors. This enforces the diversity of the cluster assignments, benefiting the segmentation and recognition of OOD tumors.
We curate two real-world medical image datasets of (pancreatic and liver) tumor images from 1,088 patients for image segmentation and OOD localization. Specifically, we collect consecutive patients’ contrast-enhanced 3D CT imaging with a full spectrum of tumor types confirmed by pathology. In these scenarios, the OOD targets are rare tu-mors and diseases. Our method shows robust performance across two datasets, significantly outperforming the previ-ous leading OOD localization methods by an average of 7.39% in AUROC, 14.69% in AUPR, 13.79% in FPR95 for localization, and 3.42% for case-level detection. Mean-while, our framework also improves the performance of in-lier segmentation by an average of 5.27% compared with the strong baseline nnUNet [24].
We summarize our main contributions as follows:
• To the best of our knowledge, we are the first to explore the near-OOD detection and localization problem in medical image segmentation. The proposed method has a strong potential for utility in clinical practice.
• We propose a novel approach, MaxQuery, using the maximum score of query response as a major indicator for OOD localization.
• A query-distribution (QD) loss is proposed to con-centrate the queries on important foreground regions, demonstrating superior effectiveness for near-OOD problems.
• We curate two medical image datasets for tumor se-mantic segmentation/detection of real-world OODs.
Our proposed framework substantially outperforms previous leading OOD localization methods and im-proves upon the inlier segmentation performance. 2.