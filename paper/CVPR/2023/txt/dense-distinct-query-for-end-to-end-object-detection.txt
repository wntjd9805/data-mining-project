Abstract 1.

Introduction
One-to-one label assignment in object detection has suc-cessfully obviated the need for non-maximum suppression (NMS) as postprocessing and makes the pipeline end-to-end. However, it triggers a new dilemma as the widely used sparse queries cannot guarantee a high recall, while dense queries inevitably bring more similar queries and en-counter optimization difficulties. As both sparse and dense queries are problematic, then what are the expected queries in end-to-end object detection? This paper shows that the solution should be Dense Distinct Queries (DDQ). Con-cretely, we first lay dense queries like traditional detectors and then select distinct ones for one-to-one assignments.
DDQ blends the advantages of traditional and recent end-to-end detectors and significantly improves the performance of various detectors including FCN, R-CNN, and DETRs.
Most impressively, DDQ-DETR achieves 52.1 AP on MS-COCO dataset within 12 epochs using a ResNet-50 back-bone, outperforming all existing detectors in the same set-ting. DDQ also shares the benefit of end-to-end detec-tors in crowded scenes and achieves 93.8 AP on Crowd-Human. We hope DDQ can inspire researchers to con-sider the complementarity between traditional methods and end-to-end detectors. The source code can be found at https://github.com/jshilong/DDQ.
* Equal contribution.
Object detection is one of the most fundamental tasks in computer vision, which aims at answering what objects are in an image and where they are. To achieve the objective, the detector is expected to detect all objects and mark each object with only one bounding box.
Due to the complex spatial distribution and the vast shape variance of objects, detecting all objects is quite chal-lenging. To solve the problem, traditional detectors [17,21, 27] first lay predefined dense grid queries1 to achieve a high recall. Convolutions with shared weights are then applied to quickly process dense queries in a sliding-window manner.
At last, one ground truth bounding box is assigned to multi-ple similar candidate queries for optimization. However, the one-to-many assignment results in redundant predic-tions and thus requires extra duplicate-removal operations (e.g., non-maximum suppression) during inference, which causes misaligned inference with training and hinders the pipeline from being end-to-end (as shown in Fig. 1.(a)).
This paradigm is broken by DETR [2], which assigns only one positive query to each ground truth bounding box (one-to-one assignment) to achieve end-to-end. This scheme requires heavy computation to refine queries and adopts self-attention to model interactions between queries 1 Anchors [17, 21] or anchor points [27] in conventional detectors play the same role as sparse object queries in [2]. Hence, we collec-tively refer to densely distributed anchor boxes and anchor points as dense queries.
to facilitate the optimization of one-to-one assignment, which unfortunately limits the number of queries. For ex-ample, DETR only initializes hundreds of learnable object queries. Therefore, compared to the densely distributed queries in conventional detectors, the sparse queries fall short in recall rate, as shown in Fig. 1.(b).
Some recent works have also tried to integrate dense queries into one-to-one assignment [24, 28, 32]. How-ever, dense queries in end-to-end detectors face unique challenges. For example, our analysis shows that this paradigm would inevitably introduce many similar queries (potentially representing the same instance) and that it suffers difficult and inefficient optimization as similar queries are assigned opposite labels under one-to-one as-signment.(Fig. 1.(c)).
Now that both sparse queries (low recall) and dense queries (optimization difficulty) under one-to-one assign-ment are sub-optimal, what are the expected queries in end-to-end object detection?
In this study, we demonstrate that the solution should be dense distinct queries (DDQ), meaning that the queries for object detection should be both densely distributed to de-tect all objects and also distinct from each other to facilitate the optimization of one-to-one label assignment. Guided by such a principle, we consistently improve the perfor-mance of various detector architectures, including FCN,
R-CNN, and DETRs. For one-stage detectors composed of fully convolutional networks (FCN), we first propose a pyramid shuffle operation to replace heavy self-attentions to model the interaction between dense queries. Then, a dis-tinct queries selection scheme ensures that the one-to-one assignment is only imposed on the selected distinct queries, preventing contradictory labels from being assigned to simi-lar queries. Such an end-to-end one-stage detector is named
DDQ FCN and achieves state-of-the-art performance in one-stage detectors. DDQ also naturally extends to DETR and R-CNN structures [7, 19, 26, 38] by first laying dense queries as in [38] and then selecting distinct queries for later refining stages, which are respectively dubbed DDQ
R-CNN and DDQ DETR.
We have conducted experiments on two datasetsâ€”MS-COCO [18] and CrowdHuman [23]. DDQ FCN and DDQ
R-CNN obtain 41.5/44.6 AP, respectively, on the MS-COCO detection dataset [18] with the standard 1x sched-ule [17, 21]. Compared to recent DETRs, DDQ DETR achieved 52.1 AP in just 12 epochs with the DETR-style augmentation [2]. The strong performance demonstrates that DDQ overcomes the optimization difficulty in end-to-end detectors and converges as fast as traditional detectors with higher performance.
Object detection in crowded scenes such as CrowdHu-man [23] is another arena to testify to the effectiveness of DDQ. It is extremely cumbersome to tune the post-processing NMS in traditional detectors, as a low IoU threshold leads to missing overlapping objects, while a high threshold brings too many false positives. Recent end-to-end structures also struggle to distinguish between dupli-cated predictions and overlapping objects due to their diffi-cult optimization. In this study, DDQ FCN/R-CNN/DETR achieve 92.7/93.5/93.8 AP and 98.2/98.6/98.7 recall on
CrowdHuman [23], surpassing both traditional and end-to-end detectors by a large margin. 2.