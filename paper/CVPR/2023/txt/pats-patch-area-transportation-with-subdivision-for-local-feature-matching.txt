Abstract
Local feature matching aims at establishing sparse cor-respondences between a pair of images. Recently, detector-free methods present generally better performance but are not satisfactory in image pairs with large scale differences.
In this paper, we propose Patch Area Transportation with
Subdivision (PATS) to tackle this issue.
Instead of build-ing an expensive image pyramid, we start by splitting the original image pair into equal-sized patches and gradu-ally resizing and subdividing them into smaller patches with the same scale. However, estimating scale differences be-tween these patches is non-trivial since the scale differ-ences are determined by both relative camera poses and scene structures, and thus spatially varying over image pairs. Moreover, it is hard to obtain the ground truth for real scenes. To this end, we propose patch area transporta-tion, which enables learning scale differences in a self-supervised manner. In contrast to bipartite graph match-ing, which only handles one-to-one matching, our patch area transportation can deal with many-to-many relation-ships. PATS improves both matching accuracy and cover-age, and shows superior performance in downstream tasks, such as relative pose estimation, visual localization, and optical flow estimation. The source code is available at https://zju3dv.github.io/pats/. 1.

Introduction
Local feature matching between images is essential in many computer vision tasks which aim to establish corre-spondences between a pair of images. In the past decades, local feature matching [3, 40] has been widely used in a large number of applications such as structure from mo-tion (SfM) [44, 64], simultaneous localization and mapping (SLAM) [30,36,62], visual localization [19,41], object pose estimation [22, 61], etc. The viewpoint change from the
*Junjie Ni and Yijin Li contributed equally to this work.
†Guofeng Zhang is the corresponding author.
Figure 1. Two-view reconstruction results of LoFTR [49],
ASpanFormer [7], PDC-Net+ [58] and our approach on
MegaDepth dataset [27]. PATS can extract high-quality matches under severe scale variations and in indistinctive regions with repetitive patterns, which allows semi-dense two-view reconstruc-tion by simply triangulating the matches in a image pair. In con-trast, other methods either obtain fewer matches or even obtain erroneous results. source image to the target image may lead to scale varia-tions, which is a long-standing challenge in local feature matching. Large variations in scale leads to two severe consequences: Firstly, the appearance is seriously distorted, which makes learning the feature similarity more challeng-ing and impacts the correspondence accuracy. Secondly, there may be several pixels in the source image correspond-ing to pixels in a local window in the target image. How-ever, existing methods [33, 40] only permit one potential target feature to be matched in the local window, and the following bipartite graph matching only allows one source pixel to win the matching. The coverage of correspondences derived from such feature matches is largely suppressed and will impact the downstream tasks.
Before the deep learning era, SIFT [33] is a milestone that tackles the scale problem by detecting local features on an image pyramid and then matching features crossing pyramid levels, called scale-space analysis. This technique is also adopted in the inference stage of learning-based lo-cal features [39]. Recently, LoFTR abandons feature detec-tion stage and learns to directly draw feature matches via simultaneously encoding features from both images based
Figure 2. Scale Alignment with Patch Area Transportation.
Our approach learns to find the many-to-many relationship and scale differences through solving the patch area transportation.
Then we crop the patches and resize the image content to align the scale, which remove the appearance distortion. on the attention mechanism. By removing the information bottleneck caused by detectors, LoFTR [49] produces bet-ter feature matches. However, LoFTR does not handle the scale problem and the scale-space analysis is infeasible in this paradigm because conducting attention intra- and inter-different scales will bring unbearable increasing computa-tional costs. As a result, the scale curse comes back again.
In this paper, we propose Patch Area Transportation with Subdivision (PATS) to tackle the scale problem in a detector-free manner. The appearance distortion can be al-leviated if the image contents are aligned according to their scale differences before feature extraction. As shown in
Fig. 2, if the target image is simply obtained by magnify-ing the source image twice, a siamese feature encoder will produce features with large discrepancies at corresponding locations. The discrepancies are corrected if we estimate the scale difference and resize the target image to half be-fore feature extraction. Considering that scale differences are spatially varying, we split the source image into equal-sized patches and then align the scale patch-wisely. Specif-ically, we identify a corresponding rectangular region in the target image for each source patch and then resize the im-age content in the region to align the scale. By also splitting the target image into patches, the rectangular regions can be represented with patches bounded by boxes. Based on this representation, one source patch corresponds to mul-tiple target patches. Moreover, the bounding box may be overlapped, indicating that one target patch may also corre-spond to multiple source patches. Here comes the question: how can we find many-to-many patch matches instead of one-to-one [7, 42, 49]?
We observe that finding target patches for a source patch can be regarded as transporting the source patch to the target bounding box, where each target patch inside the box occupies a portion of the content.
In other words, the area proportion that the target patches occupying the source patch should be summed to 1. Motivated by this observation, we propose to predict the target patches’ area and formulate patch matching as a patch area transporta-tion problem that transports areas of source patches to tar-get patches with visual similarity restrictions. Solving this problem with Sinkhorn [10], a differential optimal trans-port solver, also encourages our neural network to better capture complex visual priors. Once the patch matching is finished, the corresponding bounding boxes can be eas-ily determined. According to the patch area transportation with patch subdivision from coarse to fine, PATS signifi-cantly alleviates appearance distortion, which largely eases the difficulty of feature learning to measure visual similar-ity. Moreover, source patches being allowed to match over-lapped target patches naturally avoid the coverage reduction problem. After resizing the target regions according to es-timated scale differences, we subdivide the corresponding source patch and target region to obtain finer correspon-dences, dubbed as scale-adaptive patch subdivision. Fig. 1 shows qualitative results of our approach.
Our contributions in this work can be summarized as three folds: 1) We propose patch area transportation to handle the many-to-many patch-matching challenge and grants the ability that learning scale differences in a self-2) We pro-supervised manner to the neural network. pose a scale-adaptive patch subdivision to effectively re-fine the correspondence quality from coarse to fine. 3) Our patch area transportation with subdivision (PATS) achieves state-of-the-art performance and presents strong robustness against scale variations. 2.