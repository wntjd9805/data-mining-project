Abstract
The introduction of DETR represents a new paradigm for object detection. However, its decoder conducts classifica-tion and box localization using shared queries and cross-attention layers, leading to suboptimal results. We observe that different regions of interest in the visual feature map are suitable for performing query classification and box local-ization tasks, even for the same object. Salient regions pro-vide vital information for classification, while the bound-aries around them are more favorable for box regression.
Unfortunately, such spatial misalignment between these two tasks greatly hinders DETR’s training. Therefore, in this work, we focus on decoupling localization and classifica-tion tasks in DETR. To achieve this, we introduce a new de-sign scheme called spatially decoupled DETR (SD-DETR), which includes a task-aware query generation module and a disentangled feature learning process. We elaborately de-sign the task-aware query initialization process and divide the cross-attention block in the decoder to allow the task-aware queries to match different visual regions. Meanwhile, we also observe that the prediction misalignment problem for high classification confidence and precise localization exists, so we propose an alignment loss to further guide the spatially decoupled DETR training. Through extensive experiments, we demonstrate that our approach achieves a significant improvement in MSCOCO datasets compared to previous work. For instance, we improve the performance of
Conditional DETR by 4.5 AP. By spatially disentangling the two tasks, our method overcomes the misalignment problem and greatly improves the performance of DETR for object detection. 1.

Introduction
Object detection is a critical problem in computer vision, with traditional detectors relying on convolution to extract
Figure 1. Visualization comparison of the cross-attention map for the original DETR and split decoder DETR. To explore the pref-erence of the classification and localization branches for differ-ent regions, we make a copy of the transformer decoder so that the classification and localization branches can be decoupled en-tirely. There is a difference in the highlighted area between the two branches, and the localization branch is more focused on the object edges. informative representations of the image, including single-stage and multi-stage detectors [29, 24, 28, 1, 18]. In con-trast, recent work, such as DETR [3], breaks this paradigm.
DETR consists of an encoder and a decoder, with the en-coder extracting image features using self-attention and the decoder using these features to estimate object locations and categories in interaction with the object query. It is an end-to-end solution that does not require post-processing, such as non-maximum suppression (NMS).
However, the lack of a good positional prior to match-ing the queries to the visual feature map has been ob-served to slow down DETR’s convergence. As a result, subsequent work has focused on improving performance by developing various techniques for initializing object queries [23, 27, 7, 34, 37]. On the other hand, previous
RCNN-based object detection work [13, 35, 32] has shown
that sharing the detection head for both classification and localization tasks may result in suboptimal performance, as the classification and localization branches may have con-flicting learning targets and their actual regions of inter-est may not be well-aligned with each other. To address this issue, Double-Head R-CNN [35] disentangles the de-tection head into two dedicated branches for classification and localization, respectively. While the disentanglement of the detection head can yield satisfactory performance, there persists a conflict between the two tasks due to the fact that the features fed into both branches originate from the same proposal through the use of ROI pooling. Addi-tionally, as DETR relies heavily on attention mechanisms for information extraction, disentanglement methods used in previous RCNN-based detectors that rely on anchors or convolutional features cannot be directly transferred to the
DETR-based detector.
Our study highlights the issue of misalignment between classification and localization tasks also exists in DETR, which has been ignored for a long time. To illustrate this problem, we conduct a pilot study to decouple the classi-fication and localization branches entirely by creating two copies of the decoder. We then visualize the neuron ac-tivation maps for each of the two branches, as shown in
Figure 1. The second and third columns display the cross-attention maps for classification and localization branches, respectively. The highlighted activations of each branch are significantly different, indicating a significant semantic mis-alignment. Further analysis shows that features from differ-ent positions within an object make varying contributions to classification and localization tasks. For instance, salient regions within an object provide vital information for clas-sification, while the boundaries around objects are more fa-vorable for box localization.
To take advantage of the observation, we propose a de-coupled design scheme for the DETR decoder, as depicted in Figure 2. However, we do not naively adopt two totally isolated branches. Instead, we only split the cross-attention block in the decoder into two branches, allowing classifica-tion and localization to perform query matching with dif-ferent regions of the visual feature map. Importantly, the two branches share the self-attention layers, enabling them to cooperate with each other in detecting the same objects.
By decoupling cross-attention for classification and local-ization tasks, our proposed method achieves improved per-formance over existing DETR detectors.
Furthermore, we highlight the importance of query ini-tialization in DETR’s decoder for achieving good perfor-mance and convergence speed. In the original DETR, the input queries consist of a content query and a randomly ini-tialized positional embedding. However, after decoupling the classification and localization branches, initializing the content and positional embeddings becomes critical. To ad-Figure 2. The decoder architecture of our spatially decoupled
DETR. We split the cross-attention block to allow the classifi-cation and localization branch can perform query matching with different regions of the visual feature map. And we keep the de-coder self-attention block still shared so that queries from the two branches can better propagate information. dress this, we introduce a task-aware query generation mod-ule that learns task-specific queries based on anchor boxes.
We first find some discriminative points within the anchors boxes and then the content embedding initialization is sam-pled from the encoder’s feature map for those discriminative points. While the positional embedding is generated using sinusoidal embedding of the offsets for those points.
We also observe that the misalignment problem between accurate classification and precise localization persists, re-sulting in high classification confidence with relatively low intersection-over-union (IoU) scores, or vice versa.
In-spired by the aligned label assignment mechanism pro-posed in [6, 8, 16], we further propose an alignment loss to guide the consistency between high classification con-fidence and precise localization in our Decoupled DETR learning framework.
We summarize our contributions as follows:
• We reveal the feature and prediction misalignment problem of the classification and localization branch in DETR, which significantly limits the performance of DETR-like detectors.
• We disentangle the feature learning process for the classification and localization branches. We split the cross-attention in the decoder to allow the two branches to match different areas. We design task-aware query generation for better query initialization for the two branches. We also propose an alignment loss to guide the consistency between high classifica-tion confidence and precise localization.
• We integrate our structure into a wide range of vari-ants of DETR, and a large number of experiments on
MSCOCO demonstrate that our approach can lead to significant improvements. 2.