Abstract
Targeting for detecting anomalies of various sizes for complicated normal patterns, we propose a Template-guided Hierarchical Feature Restoration method, which in-troduces two key techniques, bottleneck compression and template-guided compensation, for anomaly-free feature restoration. Specially, our framework compresses hierar-chical features of an image by bottleneck structure to pre-serve the most crucial features shared among normal sam-ples. We design template-guided compensation to restore the distorted features towards anomaly-free features. Par-ticularly, we choose the most similar normal sample as the template, and leverage hierarchical features from the tem-plate to compensate the distorted features. The bottleneck could partially filter out anomaly features, while the com-pensation further converts the reminding anomaly features towards normal with template guidance. Finally, anoma-lies are detected in terms of the cosine distance between the pre-trained features of an inference image and the corre-sponding restored anomaly-free features. Experimental re-sults demonstrate the effectiveness of our approach, which achieves the state-of-the-art performance on the MVTec
LOCO AD dataset. 1.

Introduction
Anomaly detection is typically treated as an out-of-distribution detection problem, which learns the distribution from normal samples during training and detects outliers as anomalies during inference. Existing anomaly detection methods have achieved promising results on the MVTec AD benchmark [4], which is mainly composed of images with
*Equal contribution.
†Corresponding author.
‡Work done during an internship at Microsoft Research Asia.
Normal
Anomaly
PatchCore
RD4AD
Ours
GT
Figure 1: Anomaly detection on different categories. From top to bottom: breakfast box, pushpins, splicing connectors in MVTec LOCO AD [3], and cable, transistor in MVTec
AD [4]. From left to right: normal image, anomaly im-age, anomaly maps of PatchCore [28], RD4AD [11] and our method, and ground truth. The red color corresponds to high anomaly score, whereas the blue represents low anomaly score. Best view in color. simple normal patterns, i.e. the material surface is uniform, and background is clean, and only one object exists. How-ever, in many practical applications, normal samples are composed of multiple objects placed by rule, such as PCBs with multiple electronic components, printed surfaces with diverse contents and products with parts assembly. Figure 1 illustrates several examples with complicated structures and predefined normal layout patterns. For example, a normal breakfast box contains oatmeal, nuts, oranges, and peach, which are carefully arranged following a certain rule. Its complicated normal pattern creates difficulties for the exist-ing methods to formulate its normal distribution, and conse-quently leads to degradation on detection accuracy. More-over, the accurate anomaly localization is critical in practi-cal industrial scenarios for evaluating the impact of defects and identifying their underlying causes. Therefore, to en-hance the usability of anomaly detection methods in various practical scenarios, it is crucial to resolve the challenges as-sociated with complex normal patterns and the requirements for accurate localization.
Substantial anomaly detection methods can be catego-rized as the embedding-based paradigm, as shown in Fig-ure 2 (a). These methods identify anomalies based on the patch-level dissimilarity between the input embedding fea-ture extracted from a pre-trained network and the normal feature distribution, through such as kNN [9, 25, 28], Maha-lanobis distance [10, 26] or normalizing flows [30, 14, 44].
These methods rely on patch-wise feature comparison and prefer to detect local anomalies rather than global anoma-lies. Once the normal patterns become complicated, the cor-responding normal distribution becomes challenging to be formulated, which in turn harms the detection performance.
From the aspect of reconstruction quality divergence, nu-merous reconstruction-based methods [13, 39, 16] are pro-posed to expect perfect reconstruction on normal regions and poor reconstruction on anomaly regions, as shown in
Figure 2 (b), where the samples could be images or features.
The reconstruction-based paradigm is highly adaptable to normal samples with complicated distributions, making it suitable for anomaly detection with rich diversity. How-ever, they suffer from a significant drawback that in certain cases they may fail to detect defects, where the anomaly re-gions are reconstructed with similar quality as the normal regions. Meanwhile, reconstruction-based methods often incorporate autoencoder (AE) that involves several down-sampling operations. Image details are susceptible to being lost due to feature compression operations, which leads to blurry outputs with large reconstruction error even for nor-mal samples [16], and inevitably causes inaccurate identifi-cation of defect locations.
To address the challenges of the complicated normal data and the growing demand on accurate defect localization, we propose Template-guided Hierarchical Feature Restora-tion (THFR) network for anomaly detection, which restores anomaly-free features. The basic idea of our method is shown in Figure 2 (c), the image features are first com-pressed with bottleneck structure to filter out anomaly fea-tures at different levels, and then the distorted features are compensated with template embedding features, which is retrieved from template bank through image-level nearest neighbor search. The bottleneck structure in our approach is designed to retain the essential features that are common to normal samples. To achieve this, we propose global bot-tleneck and local bottleneck that respectively preserve nor-mal semantic features and normal detailed features. We es-tablish a template bank using multi-level embedding fea-tures of normal samples, and retrieve the most similar sam-ple as the template based on the cosine similarity with the input feature. Additionally, we introduce a template-guided compensation module that leverages relation repre-setation between input features and template features to re-store anomaly-free features.
Thanks to the template guidance and hierarchical com-pensation design, our method achieves state-of-the-art per-formance on MVTec LOCO AD [3], a dataset containing normal patterns of rich diversity, and also achieves compet-itive performance on MVTec AD [4], which is commonly used as anomaly detection benchmark.
In summary, our main contributions are threefold:
• We propose a new framework to tackle the problem of anomaly detection upon data of rich diversity, in which the anomaly-free features with complicated distribu-tion can be restored from the anomaly features with the guidance of template features.
• We design bottleneck compression to retain normal features while partially filtering out anomaly features, and propose template-guided compensation that lever-age template embedding features to restore the dis-torted features towards normal.
• Extensive experiments on the standard benchmarks demonstrate the outstanding performance of the pro-posed method, especially for localization. 2.