Abstract
Because anomalous samples cannot be used for train-ing, many anomaly detection and localization methods use pre-trained networks and non-parametric modeling to esti-mate encoded feature distribution. However, these meth-ods neglect the impact of position and neighborhood in-formation on the distribution of normal features. To over-come this, we propose a new algorithm, PNI, which es-timates the normal distribution using conditional proba-bility given neighborhood features, modeled with a multi-layer perceptron network. Moreover, position informa-tion is utilized by creating a histogram of representative features at each position.
Instead of simply resizing the anomaly map, the proposed method employs an additional refine network trained on synthetic anomaly images to bet-ter interpolate and account for the shape and edge of the input image. We conducted experiments on the MVTec
AD benchmark dataset and achieved state-of-the-art per-formance, with 99.56% and 98.98% AUROC scores in anomaly detection and localization, respectively. Code is available at https://github.com/wogur110/
PNI_Anomaly_Detection. 1.

Introduction
In industrial inspection [1], delivering defective products to customers due to detection failure can be costly, and false detection can increase manufacturing costs. Therefore, high prediction accuracy alone is insufficient, and low false pos-itive rate (FPR) and false negative rate (FNR) are preferred.
Additionally, collecting abnormal samples can be difficult, making it almost impossible to build a supervised model for the task. Thus, anomaly detection methods that use only normal samples are adopted. Anomaly localization quanti-fies the anomaly of each pixel in an input image, allowing users to identify where the defect is located and improve
*Equal contribution.
†Corresponding author.
Figure 1: Examples from MVTec AD [1]. The normal images (left) and the anomalous images (second column) overlaid by ground truth mask are followed by the anomaly maps from PatchCore [21] (third column) and our proposed approach (right). The contours overlaid on anomaly maps are from thresholds optimizing F1 scores of anomaly local-ization. manufacturing processes. Figure 1 displays example im-ages and results of an existing method and our proposed approach from the MVTec AD benchmark dataset.
Since there are only normal samples available for train-ing, conventional classification methods cannot be used.
One approach is to generate defective samples to train clas-sifiers with supervised learning [29, 28, 22]. CutPaste [17], for instance, used masks of rectangular and scar shapes to learn representation in a self-supervised manner. However, these methods show relatively low performance compared to other recent methods due to the lack of realism in ab-normal patterns. To overcome this difficulty, many recently proposed methods [6, 21] adopt a pre-trained network such as pre-trained ResNet [11] using ImageNet [8], which inten-sively learned low-level image features from a super large-sized dataset.
Various methods are utilized to model the distribution of normal features that are transformed by a pre-trained network. For example, PatchCore [21] sub-samples rep-resentative features from the extracted normal features to achieve efficient non-parametric modeling of nominal fea-tures. Similarly, CFLOW-AD [9] uses normalizing flow to model the normal feature distribution. However, these methods quantify the anomalies of input feature vectors in-dependently, without considering the correlation between neighboring features. Additionally, normal features can be abnormal if they are in the wrong position. For instance, in the first row of Figure 1, the top-view cables are nor-mal only when the color order is correct, as shown in the first column image. However, if the color order is incor-rect, the product is defective, even though all the local fea-tures are normal. Existing representation-based approaches, such as PatchCore, cannot capture this type of abnormality.
Although CFLOW-AD adopted position encoding blocks, the implicit method appears insufficient to model positional information and overlooks the correlation between normal features.
To address this problem, this paper utilizes position and neighborhood information in simple yet effective ways. At each position of the encoded feature dimension, a histogram of all the training features is constructed to model a con-ditional probability distribution given the positional infor-mation. Meanwhile, an MLP (multi-layer perceptron) net-work models the probability distribution of normal features conditioned by neighboring features, where the input is the concatenated neighboring features. Through this process, the MLP network observes a large support region, while the features remain local, allowing the proposed method to produce a finely detailed localization map. These two distributions are combined to estimate the likelihood and anomaly score of an input image and its pixels during test-ing. While PatchCore serves as a baseline to demonstrate the validity of the proposed ideas, they can be applied to any representation-based method that uses a pre-trained net-work to generate input features and non-parametric model-ing of normal features.
Representation-based approaches have a limitation in de-picting detailed anomaly maps because local features are extracted from image patches of moderate size. When the patch size is small, enough information may not be ex-tracted, leading to degraded detection performance. On the other hand, a large patch size may result in a blurred local-ization map. To overcome this problem, we trained an addi-tional refinement network with synthetic abnormal images, which improves the detail of the localization map. While the simulation of synthetic abnormalities was explored in previous works [17, 32, 34], the proposed approach is dif-ferentiated by its design of refinement network architec-ture and loss function aimed at correcting representation-based distances, and by introducing various defect gener-ation methods to enhance refinement robustness. It’s im-portant to note that synthetic images are not used to en-code input images or to estimate anomaly scores. They are used only to train the refinement network. This is dif-ferent from existing methods. By using synthetic images and corresponding anomaly maps generated by the above-mentioned method, the refinement network learns how to revise the anomaly map to look like the ground truth mask.
The proposed method resulted in a decrease in FNR from 1.83% to 0.95% compared to the current state-of-the-art method [21]. This reduction means that customers receive 48% fewer defective products. Additionally, The FPR was reduced from 4.07% to 1.50%, which means that 63% fewer good products are wasted. Although the improvement in the area under the receiver operating characteristic (AUROC) metric, 0.46%, may seem small, it can provide significant benefits to industrial manufacturing.
In summary, our contributions are threefold. Firstly, we demonstrate the effectiveness of using conditional normal feature distribution based on position and neighborhood information for anomaly detection and localization. Sec-ondly, we validate that training a refinement network with synthetic datasets can significantly enhance performance.
Finally, we provide insight into the factors that contribute to the noticeable improvement with the ablation study. 2.