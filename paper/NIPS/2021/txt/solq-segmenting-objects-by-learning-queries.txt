Abstract
In this paper, we propose an end-to-end framework for instance segmentation.
Based on the recently introduced DETR [1], our method, termed SOLQ, segments objects by learning uniﬁed queries. In SOLQ, each query represents one object and has multiple representations: class, location and mask. The object queries learned perform classiﬁcation, box regression and mask encoding simultaneously in an uniﬁed vector form. During training phase, the mask vectors encoded are supervised by the compression coding of raw spatial masks. In inference time, mask vectors produced can be directly transformed to spatial masks by the inverse process of compression coding. Experimental results show that SOLQ can achieve state-of-the-art performance, surpassing most of existing approaches. Moreover, the joint learning of uniﬁed query representation can greatly improve the detection performance of DETR. We hope our SOLQ can serve as a strong baseline for the
Transformer-based instance segmentation. Code is available at https://github. com/megvii-research/SOLQ. 1

Introduction
Instance segmentation, serving as one of visual detection tasks, not only locates instances of different categories but also generates pixel-level mask for each instance. State-of-the-art instance segmentation methods [2, 3, 4, 5] follow the two-stage paradigm, which ﬁrst performs object detection and then segments the masks within detected boxes by RoIAlign [2]. Those methods are relatively easy to be optimized thanks to the deployment of mature object detectors [6, 7]. However, the segmentation branch heavily relies on the detection branch, making it hard to achieve better joint learning of multiple tasks. Some recent works [8, 9, 10, 11] build instance segmentation frameworks on top of anchor-free object detectors [12, 13] to remove the ROI-Cropping operation, reducing the effect of feature misalignment. For example, CondInst [9] based on FCOS [12] employs dynamic convolutions [14] to perform instance segmentation. YOLACT [8] models the instance segmentation as a combination of prototypes weighted by learned mask coefﬁcients for each anchor. However, the weights of dynamic convolutions or the mask coefﬁcients are still generated by instance proposals.
Regardless of the bounding boxes, SOLO [15] introduces the notion of "instance categories" and segments objects by locations. SOLOv2 [16] further solves the problem of inefﬁcient mask represen-tation by introducing dynamic convolution and so-called matrix Non-Maximum Suppression (NMS).
Though SOLO directly outputs instance masks based on locations, hand-crafted post-processes, like
NMS, are still required to remove duplicated predictions. Also, the performance of small objects is far from satisfactory due to the imbalance of location samples between the large and small objects.
Building an end-to-end instance segmentation framework is still a remaining problem.
Our work is inspired by DETR [1], which ﬁrst proposes the end-to-end solution for object detection.
In DETR, object detection is regarded as a set prediction problem and objects are represented by
∗Equal contribution. This work is supported by The National Key Research and Development Program of
China (No.2017YFA0700800) and Beijing Academy of Artiﬁcial Intelligence (BAAI). 35th Conference on Neural Information Processing Systems (NeurIPS 2021).
learnable query embeddings. How to encode the spatial binary mask into such an end-to-end system is an opening question. As shown in Fig. 1(a), DETR is further extended to panoptic segmentation by directly reshaping the learnable embeddings into spatial domain and building a FPN-style [17] network to produce the ﬁnal mask predictions. However, both the Transformer encoder and decoder fail to model the spatial information well. Therefore, it is inappropriate to generate the spatial mask based on such query embeddings. Besides, the spatial mask labels used for supervision are of large resolutions, which results in high computation cost and makes it separated to learn the detection and mask branches2. So we need to ﬁnd one mask representation that satisﬁes the following conditions: 1) The representation can naturally convert object mask from spatial domain to embedding domain; 2)
The process that encodes the spatial masks into embeddings should be reversible; 3) Mask embeddings encoded can keep the principle components of spatial mask. We turn to methods in literature for help and surprisingly ﬁnd that classical compression coding methods (e.g. Sparse Coding [18]) just satisfy these conditions mentioned above. The mask embeddings can be simply generated from the learnable queries. In training phase, ground-truth spatial mask of each instance can be projected into low-dimensional mask embedding by compression coding and the mask embeddings are used to supervise the learning of predicted mask embeddings. In inference phase, binary spatial mask can be reconstructed from predicted mask embedding by the inverse process of compression coding.
With these analysis, we explore how to better encode the spatial mask into the end-to-end object detectors in this paper. Based on DETR, our proposed method, termed SOLQ, segments objects by learning queries. In SOLQ, we formulate the instance segmentation as the joint learning of uniﬁed query representation (UQR). The UQR learned can be used to perform parallel predictions for three sub-tasks (classiﬁcation, localization and segmentation) simultaneously and all predictions are obtained in a regression manner (see Fig. 1(b)). In this way, SOLQ directly outputs instance masks together with corresponding class conﬁdences and box coordinates. The learning of UQR can be divided into two parts: generating instance-aware query embeddings and joint supervision of multi-task learning. Speciﬁcally, all candidate instances are initialized with several learnable queries, which interact with extracted image features in Transformer decoder to produce the instance-aware query embeddings. The instance-aware query embeddings are further input to three branches of sub-tasks, which contains several linear projection layers, to generate three sub-task vectors. For the classiﬁcation and regression branches, we follow the same supervisions as in DETR [1]. For the mask branch, we conduct implicit supervision with the help of mask compression coding mentioned above.
To summarize, our contributions are:
• We propose an end-to-end framework for instance segmentation based on DETR. SOLQ formulates the instance segmentation as the joint learning of UQR. In UQR, the mask representation can be converted from spatial domain into embedding domain, which is consistent with the learnable query embeddings in DETR.
• Experiments show that SOLQ with ResNet101 achieves 40.9% mask AP and 48.7% box
AP on the challenging MS COCO dataset [19] without bells and whistles, outperforming
SOLOv2 by 1.2% mask AP and 6.1% box AP. It is worthy noting that SOLQ can improve 2.0% in box AP compared to DETR thanks to the joint learning of UQR. 2