Abstract
The ability to predict and plan into the future is fundamental for agents acting in the world. To reach a faraway goal, we predict trajectories at multiple timescales,
ﬁrst devising a coarse plan towards the goal and then gradually ﬁlling in details. In contrast, current learning approaches for visual prediction and planning fail on long-horizon tasks as they generate predictions (1) without considering goal information, and (2) at the ﬁnest temporal resolution, one step at a time. In this work we propose a framework for visual prediction and planning that is able to overcome both of these limitations. First, we formulate the problem of predicting towards a goal and propose the corresponding class of latent space goal-conditioned predictors (GCPs). GCPs signiﬁcantly improve planning efﬁciency by constraining the search space to only those trajectories that reach the goal. Further, we show how GCPs can be naturally formulated as hierarchical models that, given two observations, predict an observation between them, and by recursively subdividing each part of the trajectory generate complete sequences. This divide-and-conquer strategy is effective at long-term prediction, and enables us to design an effective hierarchical planning algorithm that optimizes trajectories in a coarse-to-ﬁne manner. We show that by using both goal-conditioning and hierarchical prediction, GCPs enable us to solve visual planning tasks with much longer horizon than previously possible. 1

Introduction
Intelligent agents aiming to solve long-horizon tasks reason about the future, make predictions, and plan ac-cordingly. Several recent approaches
[11, 71, 19, 69, 42, 21] employ pow-erful predictive models [16, 4, 20, 37] to enable agents to predict and plan in complex environments directly from visual sensory observations, without needing to engineer a state estima-tor. To plan a sequence of actions, these approaches usually use the pre-dictive model to generate candidate roll-outs starting from the current state and then search for the sequence that best reaches the goal using a cost func-tion (see Fig. 1, left). However, such
Figure 1: When planning towards faraway goals, we propose to condition the prediction of candidate trajectories on the goal, which signiﬁcantly reduces the search space of possible trajectories (left vs. middle) and enables hierarchical plan-ning approaches that break a long-horizon task into a series of short-horizon tasks by placing subgoals (right).
∗ Equal contribution. Ordering determined by a coin ﬂip. Project page: orybkin.github.io/video-gcp 34th Conference on Neural Information Processing Systems (NeurIPS 2020), Vancouver, Canada.
approaches do not scale to complex long-horizon tasks [11]. Imagine the task of planning a route from your home to the airport. The above approaches would attempt to model all possible routes starting at home and then search for those that ended up at the airport. For long-horizon problems, the number of possible trajectories grows very large, making extensive search infeasible.
In contrast, we propose a planning agent that only considers trajectories that start at home and end at the airport, i.e., makes predictions with the goal in mind. This approach both reduces prediction complexity as a simpler trajectory distribution needs to be modeled, and signiﬁcantly reduces the search space for ﬁnding the best route, as depicted in Fig. 1 (center). Indeed, we can produce a feasible plan simply as a single forward pass of the generative model, and can further reﬁne it to ﬁnd the optimal plan through iterative optimization.
However, modeling this distribution becomes challenging for long time horizons even with goal-conditioned predictors. A naive method inspired by sequential predictive approaches would predict future trajectories at a ﬁxed frequency, one step at a time — the equivalent of starting to plan the route to the airport by predicting the very ﬁrst footsteps. This can lead to large accumulating errors.
Moreover, the optimization problem of ﬁnding the best trajectory remains challenging. The sequential planning approaches are unable to focus on large important decisions as most samples are spent optimizing local variation in the trajectory. To alleviate both shortcomings, we propose to predict an a tree-structured way, starting with a coarse trajectory and recursively ﬁlling in ﬁner and ﬁner details. This is achieved by recursive application of a single module that is trained to answer: given two states, what is a state that occurs between them? This hierarchical prediction model is effective at long-term prediction and further enables us to design an efﬁcient long-horizon planning approach by employing a coarse-to-ﬁne trajectory optimization scheme.
Hierarchical prediction models naturally lend themselves to modeling the hierarchical structure present in many long-horizon tasks by breaking them into their constituent steps. However such procedural steps do not all occur on a regularly spaced schedule or last for equal lengths of time.
Therefore, we further propose a version of our model based on a novel probabilistic formulation of dynamic time warping [56] that allows the model to select which frames to generate at each level in the tree, enabling ﬂexible placement of intermediate predictions.
In summary, the contributions of this work are as follows. First, we propose a framework for goal-conditioned prediction and planning that is able to scale to visual observations by using a latent state model. Second, we extend this framework to hierarchical prediction and planning, which improves both efﬁciency and performance through the coarse-to-ﬁne strategy and effective parallelization. We further extend this method to modeling the temporal variation in subtask structure. Evaluated on a complex visual navigation task, our method scales better than alternative approaches, allowing effective control on tasks longer than possible with prior visual planning methods. 2