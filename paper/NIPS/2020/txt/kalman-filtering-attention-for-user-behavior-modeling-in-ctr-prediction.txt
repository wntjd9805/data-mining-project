Abstract
Click-through rate (CTR) prediction is one of the fundamental tasks for e-commerce search engines. As search becomes more personalized, it is necessary to capture the user interest from rich behavior data. Existing user behavior modeling algorithms develop different attention mechanisms to emphasize query-relevant behaviors and suppress irrelevant ones. Despite being extensively studied, these attentions still suffer from two limitations. First, conventional attentions mostly limit the attention
ﬁeld only to a single user’s behaviors, which is not suitable in e-commerce where users often hunt for new demands that are irrelevant to any historical behaviors.
Second, these attentions are usually biased towards frequent behaviors, which is unreasonable since high frequency does not necessarily indicate great importance.
To tackle the two limitations, we propose a novel attention mechanism, termed
Kalman Filtering Attention (KFAtt), that considers the weighted pooling in at-tention as a maximum a posteriori (MAP) estimation. By incorporating a priori,
KFAtt resorts to global statistics when few user behaviors are relevant. Moreover, a frequency capping mechanism is incorporated to correct the bias towards frequent behaviors. Ofﬂine experiments on both benchmark and a 10 billion scale real production dataset, together with an Online A/B test, show that KFAtt outperforms all compared state-of-the-arts. KFAtt has been deployed in the ranking system of
JD.com, one of the largest B2C e-commerce websites in China, serving the main trafﬁc of hundreds of millions of active users. 1

Introduction
CTR prediction is one of the fundamental tasks for e-commerce search engines. In contrast to early systems which only consider query keywords, modern search engines have become more personalized with the goal to “understand exactly what you mean and give you exactly what you want” [21]. Consequently, user behavior modeling, i.e. extracting users’ hidden interest from historical behaviors, has been considered as one of the key components in CTR prediction for e-commerce search engines.
Nowadays, a popular user behavior modeling strategy is to estimate a user’s hidden interest using the weighted pooling over one’s historical behaviors. And these pooling weights are calculated by various attention mechanisms to emphasize query-relevant behaviors and suppress query-irrelevant ones. Despite being extensively studied, existing attention mechanisms for user behavior modeling still suffer from two limitations:
• Conventional attentions mostly assume that a user’s interest under the current query key-words must be covered by one’s historical behaviors. This assumption however, usually 34th Conference on Neural Information Processing Systems (NeurIPS 2020), Vancouver, Canada.
Figure 1: Left: Even when considering very long behavior sequences (length = 400), there is still a considerable fraction of queries irrelevant to any historical behaviors. Right: For a large fraction of queries, irrelevant behaviors are with high frequency and thus overwhelm the relevant behaviors. This fraction is extremely high in categories with low inherent frequency (93% for watches). Statistics are from 10 billion real search logs from JD.com. does not hold in the e-commerce scenarios, where users often hunt for new demands that are irrelevant to any history behaviors (Fig 1, left). In such case, attention only on historical behaviors, no matter how the pooling weights are allocated, mostly deviates from the real user interest and will thus mislead the CTR prediction system.
• Conventional attentions treat all historical behaviors independently, regardless of the hi-erarchical relationship between behaviors and their corresponding queries. More clearly, behaviors under the same query are highly homogeneous but make duplicated contribution in the weighted pooling. This certainly biases the attention weights towards frequent queries, which is unreasonable since high frequency does not necessarily indicate great importance.
Given the huge variance in queries’ inherent frequency, this bias becomes even more severe.
An irrelevant but frequent query would easily overwhelm any closely related but infrequent one, and ﬁnally degrades the CTR prediction (Fig 1, right).
To address the ﬁrst limitation, we propose Kalman Filtering Attention (KFAtt-base) that extends the attention ﬁeld beyond the behaviors of one single user. Our algorithm is inspired by Kalman
ﬁltering [14] which has been wildly used in control theorem to estimate unobservable variables using a series of measurements. Specially, the historical behaviors could be modeled as measurements of the hidden user interest, each with different degrees of uncertainty. We formulate the estimation of the hidden user interest as MAP and provide a simple yet effective close-form solution. Compared to conventional attentions, this solution contains an additional global prior that enables unbiased hidden interest prediction even when few historical behaviors are relevant.
We further tackle the second limitation by proposing KFAtt-freq, an extension to KFAtt-base that captures the homogeneity of behaviors under the same query. In contrast to KFAtt-base that regards each behavior as an independent measurement, KFAtt-freq models each deduplicated query as a sensor and the behaviors under this query as repeated measurements from this sensor. We formulate this hidden interest estimation as MAP and derive the close-form solution. Compared to conventional attentions as well as KFAtt-base, this solution caps the total weights of behaviors under the same query and thus corrects the attention bias towards frequent queries.
Finally, for industrial scale online applications, we propose a KFAtt based behavior modeling module that incorporates many techniques to model behavior correlations and meet the online latency requirements. This module consists of two parts: A transformer based encoder for capturing correlations and dynamics of long behavior sequences and a KFAtt based decoder for extracting users’ target-speciﬁc hidden interest.
The main contributions of this paper can be summarized as:
• To the best of our knowledge, we are the ﬁrst to high-light the two limitations in conventional attentions for user behavior modeling, namely, the limited attention ﬁeld on a single user’s behavior and the attention bias towards frequent behaviors.
• We propose a novel attention mechanism KFAtt that successfully addresses the two limita-tions and validate it through concrete theoretical analysis and extensive experiments, both ofﬂine & Online A/B test, demonstrating our validity, effectiveness and adaptability. 2
• Based on KFAtt, we propose an efﬁcient behavior modeling module that meets the strict online latency requirements, and deploy it in the search engine of JD.com, one of the largest
B2C e-commerce websites in China. KFAtt is now serving the main trafﬁc of hundreds of millions of active users. 2